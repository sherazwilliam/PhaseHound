name: PhaseHound u22 release

on:
  workflow_dispatch:
    inputs:
      set_name:
        description: 'Release name prefix (optional). If empty â†’ repo name'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04   # glibc 2.35

    env:
      BUILD_DIR: dist        # where we stage artifacts
      BIN_ZIP: phasehound-bundle.zip

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libsoapysdr-dev libasound2-dev zip

      - name: Build
        run: |
          set -eux
          make -j"$(nproc)"

      - name: Read version from header
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          HDR="include/ph_version.h"
          if [[ ! -f "$HDR" ]]; then
            echo "::error file=$HDR::version header not found"; exit 1
          fi

          # Extract PH_VERSION_STRING "..." from the header
          VER=$(awk -F\" '/#define[ \t]+PH_VERSION_STRING/ {print $2}' "$HDR")
          if [[ -z "${VER:-}" ]]; then
            echo "::error::PH_VERSION_STRING not found in $HDR"; exit 1
          fi

          # Decide the base name shown to users
          if [[ -n "${{ inputs.set_name }}" ]]; then
            NAME="${{ inputs.set_name }}"
          else
            NAME="${GITHUB_REPOSITORY##*/}"
          fi

          # Ensure tags and compute sha7
          git fetch --tags --force --quiet
          SHA7=$(git rev-parse --short=7 HEAD)

          # If a tag equal to the version already exists, suffix both release name and tag with -<sha7>
          if git rev-parse -q --verify "refs/tags/${VER}" >/dev/null; then
            TAG="${VER}-${SHA7}"
            REL_NAME="${NAME}-${VER}-${SHA7}"
          else
            TAG="${VER}"
            REL_NAME="${NAME}-${VER}"
          fi

          echo "version=$VER"        >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"            >> "$GITHUB_OUTPUT"
          echo "rel_name=$REL_NAME"  >> "$GITHUB_OUTPUT"
          echo "sha7=$SHA7"          >> "$GITHUB_OUTPUT"

      - name: Stage release artifacts
        run: |
          set -euo pipefail
          rm -rf "$BUILD_DIR"; mkdir -p "$BUILD_DIR/addons"

          # Gather built binaries (adjust paths if yours differ)
          CORE_PATH="$(find . -maxdepth 2 -type f -name ph-core -perm -111 | head -n1 || true)"
          CLI_PATH="$(find . -maxdepth 2 -type f -name ph-cli  -perm -111 | head -n1 || true)"
          [[ -n "$CORE_PATH" && -x "$CORE_PATH" ]] && cp -v "$CORE_PATH" "$BUILD_DIR/ph-core"
          [[ -n "$CLI_PATH"  && -x "$CLI_PATH"  ]] && cp -v "$CLI_PATH"  "$BUILD_DIR/ph-cli"

          # Collect addons (*.so)
          while IFS= read -r so; do
            dest="$BUILD_DIR/addons/$(basename "$so")"
            cp -v "$so" "$dest"
          done < <(find src/addons -type f -name 'ph-lib*.so' -print | sort)

          # Zip a single bundle too
          (cd "$BUILD_DIR" && zip -9r "$BIN_ZIP" .)

      - name: Verify gh availability
        run: gh --version

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INTERNAL_TAG: ${{ steps.ver.outputs.tag }}
          REL_NAME: ${{ steps.ver.outputs.rel_name }}
        run: |
          set -euo pipefail
          cd "$BUILD_DIR"

          # Assets list
          FILES=()
          [[ -f "ph-core" ]] && FILES+=("ph-core")
          [[ -f "ph-cli"  ]] && FILES+=("ph-cli")
          while IFS= read -r so; do FILES+=("$so"); done < <(find addons -type f -name 'ph-lib*.so' -print | sort)
          [[ -f "$BIN_ZIP" ]] && FILES+=("$BIN_ZIP")

          # Create or update the release; GitHub flattens paths in asset list
          if ! gh release view "$INTERNAL_TAG" >/dev/null 2>&1; then
            gh release create "$INTERNAL_TAG" "${FILES[@]}" \
              --title "$REL_NAME" \
              --notes "Automated build for ${REL_NAME}" \
              --target "$GITHUB_SHA"
          else
            gh release upload "$INTERNAL_TAG" "${FILES[@]}" --clobber
            gh release edit "$INTERNAL_TAG" --title "$REL_NAME"
          fi
