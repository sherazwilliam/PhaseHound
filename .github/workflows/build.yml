name: PhaseHound u22 release

on:
  workflow_dispatch:
    inputs:
      set_name:
        description: 'Release name (optional). If empty â†’ PhaseHound-unmarked-<sha7>'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04   # glibc 2.35

    env:
      BUILD_DIR: dist

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libsoapysdr-dev libasound2-dev

      - name: Build
        run: |
          set -eux
          make -j"$(nproc)"

      - name: Stage release skeleton
        run: |
          set -euo pipefail
          rm -rf "$BUILD_DIR"; mkdir -p "$BUILD_DIR/addons"

          CORE_PATH="$(find . -maxdepth 2 -type f -name ph-core -perm -111 | head -n1 || true)"
          CLI_PATH="$(find . -maxdepth 2 -type f -name ph-cli  -perm -111 | head -n1 || true)"
          [ -n "${CORE_PATH:-}" ] && install -m0755 "$CORE_PATH" "$BUILD_DIR/ph-core" || echo "WARN: ph-core not found"
          [ -n "${CLI_PATH:-}"  ] && install -m0755 "$CLI_PATH"  "$BUILD_DIR/ph-cli"  || echo "WARN: ph-cli not found"

          if [ -d src/addons ]; then
            for d in src/addons/*; do
              [ -d "$d" ] || continue
              name="$(basename "$d")"
              so="$(find "$d" -maxdepth 1 -type f -name '*.so' | head -n1 || true)"
              if [ -n "${so:-}" ]; then
                mkdir -p "$BUILD_DIR/addons/$name"
                cp "$so" "$BUILD_DIR/addons/$name/ph-lib${name}.so"
              fi
            done
          fi

          echo "Release tree:"
          find "$BUILD_DIR" -type f | sort

      - name: Name release & archive
        id: meta
        run: |
          set -euo pipefail
          sha="${GITHUB_SHA::7}"
          REL_NAME="${{ inputs.set_name }}"
          [ -n "$REL_NAME" ] || REL_NAME="PhaseHound-unmarked-${sha}"
          ARCHIVE="phasehound-${sha}-linux-amd64.tar.gz"
          INTERNAL_TAG="auto-${sha}-u22"   # internal-only

          echo "REL_NAME=$REL_NAME"        >> "$GITHUB_ENV"
          echo "ARCHIVE=$ARCHIVE"          >> "$GITHUB_ENV"
          echo "INTERNAL_TAG=$INTERNAL_TAG" >> "$GITHUB_ENV"

      - name: Pack tarball (no leading ./)
        run: |
          set -eux
          cd "$BUILD_DIR"
          files=()
          [ -f ph-core ] && files+=(ph-core)
          [ -f ph-cli  ] && files+=(ph-cli)
          [ -d addons  ] && files+=(addons)
          tar -czf "../$ARCHIVE" "${files[@]}"
          cd - >/dev/null
          sha256sum "$ARCHIVE" > "$ARCHIVE.sha256"
          echo "Archive content:"; tar -tf "$ARCHIVE" | sed -n '1,50p'

      - name: Upload CI artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REL_NAME }}
          path: |
            ${{ env.ARCHIVE }}
            ${{ env.ARCHIVE }}.sha256
            ${{ env.BUILD_DIR }}/ph-core
            ${{ env.BUILD_DIR }}/ph-cli
            ${{ env.BUILD_DIR }}/addons/*/ph-lib*.so
          retention-days: 7

      - name: Publish GitHub Release (tarball + individual files; no local tagging)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Build a file list: tarball + checksum + individual artifacts
          FILES=()
          FILES+=("$ARCHIVE" "$ARCHIVE.sha256")
          [ -f "$BUILD_DIR/ph-core" ] && FILES+=("$BUILD_DIR/ph-core")
          [ -f "$BUILD_DIR/ph-cli"  ] && FILES+=("$BUILD_DIR/ph-cli")
          while IFS= read -r so; do FILES+=("$so"); done < <(find "$BUILD_DIR/addons" -type f -name 'ph-lib*.so' -print | sort)

          # Create or update the release; GitHub flattens path to basenames in asset list
          if ! gh release view "$INTERNAL_TAG" >/dev/null 2>&1; then
            gh release create "$INTERNAL_TAG" "${FILES[@]}" \
              --title "$REL_NAME" \
              --notes "Automated build with both full archive and individual artifacts." \
              --target "$GITHUB_SHA"
          else
            gh release upload "$INTERNAL_TAG" "${FILES[@]}" --clobber
            gh release edit "$INTERNAL_TAG" --title "$REL_NAME"
          fi
