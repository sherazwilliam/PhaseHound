name: PhaseHound musl release

on:
  workflow_dispatch:
    inputs:
      set_name:
        description: 'Release name (optional). If empty â†’ PhaseHound-unmarked-<sha7>'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container: alpine:3.20   # musl userland

    env:
      BUILD_DIR: dist

    steps:
      - name: Prepare tools
        run: |
          set -eux
          apk add --no-cache \
            git build-base pkgconfig \
            soapysdr-dev alsa-lib-dev \
            ca-certificates github-cli
          update-ca-certificates || true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build (musl)
        run: |
          set -eux
          make -j"$(nproc)"

      - name: Stage release skeleton
        run: |
          set -euo pipefail
          rm -rf "$BUILD_DIR"; mkdir -p "$BUILD_DIR/addons"

          # binaries
          CORE_PATH="$(find . -maxdepth 2 -type f -name ph-core -perm -111 | head -n1 || true)"
          CLI_PATH="$(find . -maxdepth 2 -type f -name ph-cli  -perm -111 | head -n1 || true)"
          [ -n "${CORE_PATH:-}" ] && install -m0755 "$CORE_PATH" "$BUILD_DIR/ph-core" || echo "WARN: ph-core not found"
          [ -n "${CLI_PATH:-}"  ] && install -m0755 "$CLI_PATH"  "$BUILD_DIR/ph-cli"  || echo "WARN: ph-cli not found"

          # plugins -> ./addons/<name>/ph-lib<name>.so
          if [ -d src/addons ]; then
            for d in src/addons/*; do
              [ -d "$d" ] || continue
              name="$(basename "$d")"
              so="$(find "$d" -maxdepth 1 -type f -name '*.so' | head -n1 || true)"
              if [ -n "${so:-}" ]; then
                mkdir -p "$BUILD_DIR/addons/$name"
                cp "$so" "$BUILD_DIR/addons/$name/ph-lib${name}.so"
              fi
            done
          fi

          echo "Release tree:"
          find "$BUILD_DIR" -type f | sort

      - name: Name release & archive
        id: meta
        run: |
          set -euo pipefail
          sha="${GITHUB_SHA::7}"
          REL_NAME="${{ inputs.set_name }}"
          [ -n "$REL_NAME" ] || REL_NAME="PhaseHound-unmarked-${sha}"

          ARCHIVE="phasehound-linux-musl-${sha}.tar.gz"

          echo "REL_NAME=$REL_NAME" >> "$GITHUB_ENV"
          echo "ARCHIVE=$ARCHIVE"   >> "$GITHUB_ENV"

      - name: Pack tarball (no leading ./)
        run: |
          set -eux
          cd "$BUILD_DIR"
          files=( )
          [ -f ph-core ] && files+=(ph-core)
          [ -f ph-cli  ] && files+=(ph-cli)
          [ -d addons  ] && files+=(addons)
          tar -czf "../$ARCHIVE" "${files[@]}"
          cd - >/dev/null
          sha256sum "$ARCHIVE" > "$ARCHIVE.sha256"
          echo "Archive content:"; tar -tf "$ARCHIVE" | sed -n '1,50p'

      - name: Upload CI artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REL_NAME }}
          path: |
            ${{ env.ARCHIVE }}
            ${{ env.ARCHIVE }}.sha256
          retention-days: 7

      - name: Publish GitHub Release (no local tagging)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="auto-musl-${GITHUB_SHA::7}"   # internal tag only
          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" "$ARCHIVE" "$ARCHIVE.sha256" \
              --title "$REL_NAME" \
              --notes "Automated musl build." \
              --target "$GITHUB_SHA"
          else
            gh release upload "$tag" "$ARCHIVE" "$ARCHIVE.sha256" --clobber
            gh release edit "$tag" --title "$REL_NAME"
          fi
